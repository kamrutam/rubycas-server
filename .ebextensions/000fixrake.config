commands:
  00_add_sudoers:
    command: "echo 'webapp  ALL = NOPASSWD: ALL' > /etc/sudoers.d/webapp"
  02_fix_asset_compliation:
    command: "mv /tmp/11_asset_compilation.sh /opt/elasticbeanstalk/hooks/appdeploy/pre/11_asset_compilation.sh"

files:
  /tmp/11_asset_compilation.sh:
    mode: "000755"
    content: |
      #!/usr/bin/env bash

      . /opt/elasticbeanstalk/containerfiles/envvars

      if [ "$RAILS_SKIP_ASSET_COMPILATION" == "true" ]; then
          echo "Skipping asset compilation (RAILS_SKIP_ASSET_COMPILATION=true)."
      else
          cd $EB_CONFIG_APP_ONDECK
          echo "running 'bundle exec rake assets:precompile'..."

          su -c "/usr/local/bin/bundle exec rake assets:precompile" $EB_CONFIG_APP_USER

          if [ $? != 0 ]; then
              echo "Rake task failed to run, skipping asset compilation."
          else
              echo "Asset compilation succesful"
          fi
      fi

      true
